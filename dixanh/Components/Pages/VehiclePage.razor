@page "/vehicles"
@inherits VehicleBase

<PageTitle>Quản lý xe - Đi Xanh</PageTitle>

<AuthorizeView Context="authContext">
    <Authorized>
        <main class="flex-1 p-2">
            <div class="mb-4">
                <div class="text-sm text-slate-500">Dashboard / <span class="text-slate-700">Vehicles</span></div>
                <div class="mt-1 flex items-center justify-between gap-3">
                    <div class="text-2xl font-semibold text-slate-900">List vehicle</div>

                    <button class="rounded-lg bg-emerald-600 px-4 py-2 font-semibold text-white hover:bg-emerald-700"
                            @onclick="() => OpenDrawerCreate(authContext.User.Identity?.Name)">
                        + Tạo mới
                    </button>
                </div>
            </div>

            <!-- Filter -->
            <section class="rounded-xl border border-slate-200 bg-white shadow-sm">
                <div class="p-4">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-4">
                        <div>
                            <label class="text-sm font-medium text-slate-700">Biển kiểm soát</label>
                            <input class="mt-1 w-full rounded-lg border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"
                                   placeholder="68G-000.01"
                                   @bind="_filterPlate" @bind:event="oninput" />
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700">Số hiệu xe</label>
                            <input class="mt-1 w-full rounded-lg border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"
                                   placeholder="RG7032"
                                   @bind="_filterVehicleCode" @bind:event="oninput" />
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700">Tạo lúc (UTC, 24h)</label>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <input type="datetime-local" class="w-full rounded-lg border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"
                                       @bind="_createdFromLocal" />
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700">Cập nhật lúc (UTC, 24h)</label>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <input type="datetime-local" class="w-full rounded-lg border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"
                                       @bind="_createdToLocal" />
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700">Trạng thái</label>
                            <select class="mt-1 w-full rounded-lg border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"
                                    @bind="_filterStatusId">
                                <option value="">All</option>
                                @foreach (var s in _statuses)
                                {
                                    <option value="@s.StatusId">@s.Name</option>
                                }
                            </select>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700">Thương hiệu</label>
                            <input class="mt-1 w-full rounded-lg border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"
                                   placeholder="Vinfast VF5"
                                   @bind="_filterBrand" @bind:event="oninput" />
                        </div>

                    </div>

                    <div class="mt-4 flex flex-wrap justify-end gap-2">
                        <button class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-700 hover:bg-slate-50"
                                @onclick="ResetFilters">
                            Reset
                        </button>
                        <button class="rounded-lg bg-emerald-600 px-4 py-2 font-semibold text-white hover:bg-emerald-700"
                                @onclick="() => LoadAsync(page: 1)">
                            Tìm kiếm
                        </button>
                    </div>
                </div>
            </section>

            <!-- Table -->
            <section class="mt-6 rounded-xl border border-slate-200 bg-white shadow-sm">
                <div class="flex items-center justify-between p-4">
                    <div class="text-sm text-slate-700">
                        <span class="font-semibold">Số bảng ghi:</span> @_total
                    </div>
                </div>

                <div class="overflow-auto border-t border-slate-200">
                    <table class="w-full min-w-[1200px] text-sm">
                        <thead class="sticky top-0 bg-slate-50">
                            <tr class="text-left text-slate-600">
                                <th class="px-4 py-3 font-medium">MaXe</th>
                                <th class="px-4 py-3 font-medium">Biển số</th>
                                <th class="px-4 py-3 font-medium">Số hiệu</th>
                                <th class="px-4 py-3 font-medium">Thương hiệu</th>
                                <th class="px-4 py-3 font-medium">Số chỗ</th>
                                <th class="px-4 py-3 font-medium">Màu</th>
                                <th class="px-4 py-3 font-medium">Ngày SX</th>
                                <th class="px-4 py-3 font-medium">Trạng thái</th>
                                <th class="px-4 py-3 font-medium">Tạo lúc</th>
                                <th class="px-4 py-3 font-medium">Cập nhật</th>
                                <th class="px-4 py-3 font-medium">Actions</th>
                            </tr>
                        </thead>

                        <tbody class="divide-y divide-slate-200">
                            @if (_loading)
                            {
                                <tr><td class="px-4 py-6 text-slate-600" colspan="11">Loading...</td></tr>
                            }
                            else if (_items.Count == 0)
                            {
                                <tr><td class="px-4 py-6 text-slate-600" colspan="11">No data</td></tr>
                            }
                            else
                            {
                                @foreach (var v in _items)
                                {
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-3 text-slate-900">@ShortId(v.VehicleId)</td>
                                        <td class="px-4 py-3">@v.LicensePlate</td>
                                        <td class="px-4 py-3">@v.VehicleCode</td>
                                        <td class="px-4 py-3">@v.Brand</td>
                                        <td class="px-4 py-3">@v.SeatCount</td>
                                        <td class="px-4 py-3">@v.Color</td>
                                        <td class="px-4 py-3">@FormatDate(v.ManufactureDate)</td>
                                        <td class="px-4 py-3">
                                            @StatusBadge(v.Status?.Code, v.Status?.Name)
                                        </td>
                                        <td class="px-4 py-3">@FormatDateTime(v.CreatedAt)</td>
                                        <td class="px-4 py-3">@FormatDateTime(v.UpdatedAt)</td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <button class="rounded border border-slate-300 px-2 py-1 hover:bg-slate-50"
                                                        @onclick="() => OpenDrawerView(v.VehicleId)">
                                                    View
                                                </button>
                                                <button class="rounded border border-slate-300 px-2 py-1 hover:bg-slate-50"
                                                        @onclick="() => OpenDrawerEdit(v.VehicleId)">
                                                    Edit
                                                </button>
                                                <button class="rounded border border-slate-300 px-2 py-1 hover:bg-slate-50"
                                                        @onclick="() => OpenDrawerHistory(v.VehicleId)">
                                                    History
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="flex items-center justify-between p-4 text-sm text-slate-600">
                    <div>Hiện @((_page - 1) * _pageSize + 1)–@Math.Min(_page * _pageSize, _total)</div>
                    <div class="flex items-center gap-2">
                        <button class="rounded border border-slate-300 px-3 py-1.5 hover:bg-slate-50"
                                disabled="@(_page <= 1)"
                                @onclick="() => LoadAsync(_page - 1)">
                            Lùi lại
                        </button>
                        <button class="rounded border border-slate-300 px-3 py-1.5 hover:bg-slate-50"
                                disabled="@(_page* _pageSize>=_total)"
                                @onclick="() => LoadAsync(_page + 1)">
                            Kế tiếp
                        </button>
                    </div>
                </div>
            </section>

            <!-- Drawer -->
            <VehicleDrawer Open="_drawerOpen"
                           Mode="_drawerMode"
                           VehicleId="_selectedVehicleId"
                           CurrentUserName="_currentUserName"
                           OnClose="CloseDrawer"
                           OnSaved="ReloadAfterSave" />
        </main>
    </Authorized>
</AuthorizeView>

@code {
    private static string ShortId(string id) => string.IsNullOrWhiteSpace(id) ? "" : (id.Length <= 10 ? id : id[..10] + "...");
    private static string FormatDate(DateTime? d) => d.HasValue ? d.Value.ToString("dd/MM/yyyy") : "";
    private static string FormatDateTime(DateTime? d) => d.HasValue ? d.Value.ToString("dd/MM/yyyy HH:mm:ss") : "";

    private RenderFragment StatusBadge(string? code, string? name) => builder =>
    {
        var (cls, text) = code switch
        {
            "ACTIVE" => ("border-emerald-200 bg-emerald-50 text-emerald-700", name ?? "Hoạt động"),
            "MAINTENANCE" => ("border-amber-200 bg-amber-50 text-amber-800", name ?? "Bảo trì"),
            "INACTIVE" => ("border-slate-200 bg-slate-50 text-slate-700", name ?? "Ngừng"),
            _ => ("border-slate-200 bg-slate-50 text-slate-700", name ?? "N/A")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", $"inline-flex items-center rounded-full border px-2 py-0.5 {cls}");
        builder.AddContent(2, text);
        builder.CloseElement();
    };
}
