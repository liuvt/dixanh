@inherits LayoutComponentBase

<div hidden></div>
<div class="isolate">
    <div class="max-w-screen overflow-x-hidden">
        <div class="fixed inset-x-0 top-0 z-10">
            <NavMenu />
        </div>
        <!-- Vehicle List Page (Tailwind) -->
        <div class="min-h-screen bg-slate-50 pt-16">

            <div class="flex">
                <!-- Sidebar -->
                <aside class="min-h-[calc(100vh-56px)] w-60 bg-slate-900 text-slate-100">
                    <div class="p-3">
                        <div class="px-3 py-2 text-xs text-slate-400 uppercase">Management</div>

                        <NavLink href="/dashboard"
                                 class="group flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-white/5"
                                 ActiveClass="border border-emerald-500/20 bg-emerald-500/15 text-emerald-200">
                            <span class="h-2 w-2 rounded-full bg-emerald-400 opacity-0 transition-opacity group-aria-[current=page]:opacity-100"></span>
                            Trang chính
                        </NavLink>

                        <NavLink href="/vehicles"
                                 class="group mt-1 flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-white/5"
                                 ActiveClass="border border-emerald-500/20 bg-emerald-500/15 text-emerald-200">
                            <span class="h-2 w-2 rounded-full bg-emerald-400 opacity-0 transition-opacity group-aria-[current=page]:opacity-100"></span>
                            Quản lý xe
                        </NavLink>

                        <NavLink href="/CooperationProfile"
                                 class="group mt-1 flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-white/5"
                                 ActiveClass="border border-emerald-500/20 bg-emerald-500/15 text-emerald-200">
                            <span class="h-2 w-2 rounded-full bg-emerald-400 opacity-0 transition-opacity group-aria-[current=page]:opacity-100"></span>
                            Quản lý hợp đồng
                        </NavLink>

                        <NavLink href="/contracts"
                                 class="group mt-1 flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-white/5"
                                 ActiveClass="border border-emerald-500/20 bg-emerald-500/15 text-emerald-200">
                            <span class="h-2 w-2 rounded-full bg-emerald-400 opacity-0 transition-opacity group-aria-[current=page]:opacity-100"></span>
                            Hợp đồng
                        </NavLink>
                    </div>
                </aside>
                <!-- Main Content -->
                <main class="mt-2 ml-2 flex-1 overflow-y-auto">
                    @Body
                </main>
            </div>
        </div>
    </div>
</div>

@code {

    [Inject]
    protected IAuthService AuthService { get; set; } = default!;
    [Inject]
    protected NavigationManager Nav { get; set; } = default!;
    protected bool _checkedAuthOnce;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _checkedAuthOnce) return;
        _checkedAuthOnce = true;

        try
        {
            // Nếu CheckAuthenState() có JS interop (localStorage), gọi ở đây là đúng chỗ
            if (!await AuthService.CheckAuthenState())
                Nav.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            // Đừng nuốt exception, ít nhất log để biết nguyên nhân thật
            Console.WriteLine(ex.Message, "CheckAuthenState failed on login page.");
        }
    }
}

